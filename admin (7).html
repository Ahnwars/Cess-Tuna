<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cess Tuna ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root { --red:#E8272B; --yellow:#FFD600; --dark:#111111; --gray:#1C1C1C; --light:#F5F0E8; --muted:#888; --green:#22c55e; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--dark); color:var(--light); font-family:'DM Sans',sans-serif; min-height:100vh; }

  /* LOGIN */
  .login-screen { position:fixed; inset:0; background:#090909; z-index:99999; display:flex; align-items:center; justify-content:center; }
  .login-screen.hidden { display:none; }
  .login-box { background:#161616; border:2px solid var(--red); border-radius:12px; padding:40px 36px; width:100%; max-width:360px; text-align:center; }
  .login-lock { font-size:3rem; margin-bottom:16px; }
  .login-logo { font-family:'Bebas Neue',sans-serif; font-size:2.2rem; letter-spacing:3px; color:var(--yellow); text-shadow:2px 2px 0 var(--red); margin-bottom:4px; }
  .login-sub { font-size:0.75rem; color:var(--muted); letter-spacing:2px; text-transform:uppercase; margin-bottom:28px; }
  .login-label { display:block; font-size:0.75rem; color:var(--muted); letter-spacing:1px; text-transform:uppercase; text-align:left; margin-bottom:8px; }
  .login-input { width:100%; background:#0d0d0d; border:1px solid #2a2a2a; border-radius:6px; padding:14px 16px; color:var(--light); font-size:1rem; font-family:'DM Sans',sans-serif; margin-bottom:14px; transition:border-color 0.2s; letter-spacing:3px; }
  .login-input:focus { outline:none; border-color:var(--red); }
  .login-btn { width:100%; background:var(--red); color:#fff; border:none; padding:14px; border-radius:6px; font-family:'Bebas Neue',sans-serif; font-size:1.2rem; letter-spacing:2px; cursor:pointer; transition:background 0.2s; }
  .login-btn:hover { background:#c41e21; }
  .login-btn:disabled { background:#444; cursor:not-allowed; }
  .login-error { color:#ff6b6b; font-size:0.82rem; font-weight:600; margin-top:12px; display:none; }
  .login-attempts { font-size:0.72rem; color:#555; margin-top:8px; }

  /* HEADER */
  header { background:#0d0d0d; border-bottom:3px solid var(--red); padding:20px 40px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:50; }
  .admin-logo { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:3px; color:var(--yellow); text-shadow:2px 2px 0 var(--red); }
  .admin-logo span { color:var(--muted); font-size:1rem; font-family:'DM Sans',sans-serif; letter-spacing:1px; font-weight:400; margin-left:12px; vertical-align:middle; }
  .view-site-btn { background:none; border:2px solid #333; color:var(--muted); padding:9px 20px; border-radius:4px; cursor:pointer; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.85rem; letter-spacing:1px; text-transform:uppercase; transition:all 0.2s; text-decoration:none; display:inline-block; }
  .view-site-btn:hover { border-color:var(--yellow); color:var(--yellow); }

  /* LAYOUT */
  .admin-body { display:grid; grid-template-columns:340px 1fr; gap:0; min-height:calc(100vh - 73px); }
  .sidebar { background:#0d0d0d; border-right:1px solid #1e1e1e; padding:30px 24px; display:flex; flex-direction:column; gap:20px; }

  /* KILL SWITCH */
  .kill-card { background:#161616; border:2px solid #2a0000; border-radius:10px; padding:22px; transition:border-color 0.3s,box-shadow 0.3s; }
  .kill-card.shutdown { border-color:var(--red); box-shadow:0 0 24px rgba(232,39,43,0.2); animation:dangerPulse 2.5s infinite; }
  @keyframes dangerPulse { 0%,100%{box-shadow:0 0 10px rgba(232,39,43,0.15)} 50%{box-shadow:0 0 28px rgba(232,39,43,0.4)} }
  .kill-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; color:var(--red); margin-bottom:6px; }
  .kill-desc { font-size:0.78rem; color:var(--muted); line-height:1.5; margin-bottom:18px; }
  .kill-desc.danger { color:#ff6b6b; font-weight:600; }
  .big-switch { width:100%; padding:14px; border-radius:8px; border:none; font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; cursor:pointer; transition:all 0.25s; display:flex; align-items:center; justify-content:center; gap:10px; }
  .big-switch.online { background:#14532d; color:#4ade80; border:2px solid #166534; }
  .big-switch.online:hover { background:#166534; }
  .big-switch.offline { background:#7f1d1d; color:#fca5a5; border:2px solid var(--red); }
  .big-switch.offline:hover { background:#991b1b; }
  .confirm-box { display:none; margin-top:14px; background:#1a0505; border:1px solid #5a0000; border-radius:8px; padding:14px; }
  .confirm-box p { font-size:0.82rem; color:#ff8080; font-weight:600; margin-bottom:12px; line-height:1.5; }
  .confirm-btns { display:flex; gap:8px; }
  .confirm-yes { flex:1; background:var(--red); color:#fff; border:none; padding:10px; border-radius:4px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; font-size:0.85rem; }
  .confirm-yes:hover { background:#c41e21; }
  .confirm-no { flex:1; background:#2a2a2a; color:var(--light); border:none; padding:10px; border-radius:4px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; font-size:0.85rem; }
  .confirm-no:hover { background:#3a3a3a; }
  .status-pill { display:inline-flex; align-items:center; gap:6px; padding:5px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-top:14px; }
  .status-pill.live { background:rgba(34,197,94,0.12); color:#4ade80; border:1px solid #166534; }
  .status-pill.down { background:rgba(232,39,43,0.12); color:#f87171; border:1px solid #7f1d1d; }
  .status-dot { width:8px; height:8px; border-radius:50%; }
  .status-dot.live { background:#4ade80; box-shadow:0 0 8px #4ade80; animation:blink 1.5s infinite; }
  .status-dot.down { background:var(--red); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* STATS */
  .stats-card { background:#161616; border:1px solid #2a2a2a; border-radius:10px; padding:18px 22px; }
  .stats-title { font-size:0.7rem; text-transform:uppercase; letter-spacing:2px; color:var(--muted); margin-bottom:10px; }
  .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .stat-item { text-align:center; }
  .stat-num { font-family:'Bebas Neue',sans-serif; font-size:2rem; color:var(--yellow); line-height:1; }
  .stat-label { font-size:0.7rem; color:var(--muted); margin-top:2px; }

  /* SOUND TOGGLE */
  .sound-card { background:#161616; border:1px solid #2a2a2a; border-radius:10px; padding:14px 18px; display:flex; align-items:center; justify-content:space-between; }
  .sound-label { font-size:0.8rem; font-weight:600; color:var(--muted); }
  .sound-toggle { background:#14532d; color:#4ade80; border:1px solid #166534; padding:6px 14px; border-radius:4px; font-size:0.75rem; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.2s; }
  .sound-toggle.off { background:#2a2a2a; color:#555; border-color:#333; }

  .clear-btn { background:none; border:1px solid #2a2a2a; color:#555; padding:6px 14px; border-radius:4px; cursor:pointer; font-family:'DM Sans',sans-serif; font-size:0.75rem; font-weight:600; transition:all 0.2s; }
  .clear-btn:hover { border-color:var(--red); color:var(--red); }

  /* ORDERS */
  .orders-panel { padding:30px 32px; overflow-y:auto; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; }
  .panel-title { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:3px; }
  .panel-title span { color:var(--red); }
  .refresh-btn { background:#1e1e1e; border:1px solid #2a2a2a; color:var(--muted); padding:8px 16px; border-radius:4px; cursor:pointer; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.8rem; letter-spacing:1px; text-transform:uppercase; transition:all 0.2s; }
  .refresh-btn:hover { border-color:var(--yellow); color:var(--yellow); }
  .no-orders { text-align:center; color:var(--muted); padding:80px 20px; }
  .no-orders-icon { font-size:3.5rem; margin-bottom:14px; }
  .order-card { background:#161616; border:1px solid #2a2a2a; border-radius:8px; padding:20px; margin-bottom:16px; animation:fadeUp 0.3s ease both; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .order-card.new-order { border-color:var(--yellow); }
  .oc-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
  .oc-id { font-family:'Bebas Neue',sans-serif; font-size:1.3rem; letter-spacing:1px; color:var(--yellow); }
  .oc-time { font-size:0.78rem; color:var(--muted); }
  .oc-customer { font-weight:600; margin-bottom:4px; }
  .oc-address { font-size:0.85rem; color:var(--muted); margin-bottom:12px; }
  .oc-items { font-size:0.9rem; line-height:1.8; margin-bottom:12px; }
  .oc-total { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; color:var(--yellow); margin-bottom:12px; }
  .oc-note { font-size:0.82rem; color:#aaa; margin-bottom:10px; }
  .new-badge { background:var(--red); color:#fff; font-size:0.68rem; font-weight:700; letter-spacing:1px; padding:3px 8px; border-radius:2px; text-transform:uppercase; margin-left:10px; animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
  .oc-status-badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:0.72rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-bottom:10px; }
  .badge-received  { background:#1e3a5f; color:#93c5fd; }
  .badge-preparing { background:#3a2a00; color:var(--yellow); }
  .badge-ontheway  { background:#1a2a00; color:#bef264; }
  .badge-delivered { background:#0a2a0a; color:#4ade80; }
  .status-btns { display:flex; gap:6px; flex-wrap:wrap; margin-top:14px; }
  .status-btn { flex:1; min-width:70px; padding:7px 4px; border:1px solid #333; border-radius:4px; font-size:0.7rem; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; text-transform:uppercase; background:#1e1e1e; color:var(--muted); transition:all 0.2s; }
  .status-btn:hover { border-color:var(--yellow); color:var(--yellow); }
  .s-received  { background:#1e3a5f; border-color:#3b82f6; color:#93c5fd; }
  .s-preparing { background:#3a2a00; border-color:var(--yellow); color:var(--yellow); }
  .s-ontheway  { background:#1a2a00; border-color:#84cc16; color:#bef264; }
  .s-delivered { background:#0a2a0a; border-color:#22c55e; color:#4ade80; }
  .card-actions { display:flex; gap:8px; margin-top:10px; }
  .print-btn { background:#1e1e1e; border:1px solid #2a2a2a; color:var(--muted); padding:7px 14px; border-radius:4px; font-size:0.75rem; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.2s; }
  .print-btn:hover { border-color:var(--yellow); color:var(--yellow); }

  /* NEW ORDER NOTIFICATION */
  .new-order-banner { position:fixed; top:80px; right:20px; background:#14532d; border:2px solid #22c55e; border-radius:10px; padding:16px 20px; z-index:300; transform:translateX(200px); transition:transform 0.4s cubic-bezier(0.4,0,0.2,1); max-width:260px; }
  .new-order-banner.show { transform:translateX(0); }
  .nob-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; color:#4ade80; margin-bottom:4px; }
  .nob-text { font-size:0.8rem; color:#86efac; }

  @media (max-width:768px) {
    .admin-body { grid-template-columns:1fr; }
    header { padding:16px 20px; }
    .sidebar { border-right:none; border-bottom:1px solid #1e1e1e; }
    .orders-panel { padding:20px; }
  }

  @media print {
    .login-screen,.sidebar,header,.status-btns,.card-actions,.panel-header,.new-order-banner { display:none !important; }
    .admin-body { grid-template-columns:1fr !important; }
    .order-card { border:1px solid #ccc; break-inside:avoid; }
    body { background:#fff; color:#000; }
    .oc-id,.oc-total { color:#000; }
    .oc-time,.oc-address,.oc-customer,.oc-items { color:#333; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-lock">üîê</div>
    <div class="login-logo">CESS TUNA</div>
    <div class="login-sub">Admin Access Only</div>
    <label class="login-label">Enter Password</label>
    <input class="login-input" type="password" id="loginInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button class="login-btn" id="loginBtn">LOGIN</button>
    <div class="login-error" id="loginError">‚ùå Incorrect password. Try again.</div>
    <div class="login-attempts" id="loginAttempts"></div>
  </div>
</div>

<!-- NEW ORDER NOTIFICATION -->
<div class="new-order-banner" id="newOrderBanner">
  <div class="nob-title">üîî New Order!</div>
  <div class="nob-text" id="newOrderText">A new order just came in!</div>
</div>

<header>
  <div class="admin-logo">CESS TUNA <span>Admin Panel</span></div>
  <a href="index.html" class="view-site-btn" target="_blank">üåê View Site</a>
</header>

<div class="admin-body">
  <aside class="sidebar">

    <div class="kill-card" id="killCard">
      <div class="kill-title">‚ö° Site Kill Switch</div>
      <p class="kill-desc" id="killDesc">Shut down the site when client hasn't paid.</p>
      <button class="big-switch online" id="bigSwitch">
        <span id="switchIcon">üü¢</span>
        <span id="switchLabel">SITE IS LIVE ‚Äî CLICK TO SHUT DOWN</span>
      </button>
      <div class="confirm-box" id="confirmBox">
        <p>‚ö†Ô∏è This shows a CLOSED screen to all customers. Confirm?</p>
        <div class="confirm-btns">
          <button class="confirm-yes" id="confirmYes">YES, SHUT DOWN</button>
          <button class="confirm-no" id="confirmNo">Cancel</button>
        </div>
      </div>
      <div>
        <span class="status-pill live" id="statusPill">
          <span class="status-dot live" id="statusDot"></span>
          <span id="statusText">Site Online</span>
        </span>
      </div>
    </div>

    <div class="stats-card">
      <div class="stats-title">üìä Stats</div>
      <div class="stats-grid">
        <div class="stat-item"><div class="stat-num" id="statOrders">0</div><div class="stat-label">Active Orders</div></div>
        <div class="stat-item"><div class="stat-num" id="statRevenue">0</div><div class="stat-label">Revenue (‚Ç±)</div></div>
      </div>
    </div>

    <div class="sound-card">
      <div class="sound-label">üîî Sound Alerts</div>
      <button class="sound-toggle" id="soundToggle">ON</button>
    </div>

    <button class="clear-btn" id="clearBtn">üóë Clear All Orders</button>

  </aside>

  <main class="orders-panel">
    <div class="panel-header">
      <div class="panel-title">INCOMING <span>ORDERS</span></div>
      <button class="refresh-btn" id="refreshBtn">‚Üª Refresh</button>
    </div>
    <div id="ordersList"></div>
  </main>
</div>

<script>
var API_KEY      = '$2a$10$VgEOzGTqUc4FOjCZulSrI.AE50EZQuuiTxtV9ONIyyFYOVTlBCjXK';
var SHUTDOWN_BIN = '699db35843b1c97be999be52';
var ORDERS_BIN   = '699db83cd0ea881f40d53452';
var isShutdown   = false;
var allOrders    = [];
var attempts     = 0;
var locked       = false;
var soundOn      = true;
var lastOrderCount = 0;

// XOR password: jansport1234
var _p = [64,75,68,89,90,69,88,94,27,24,25,30];
function getPassword() { return _p.map(function(c){ return String.fromCharCode(c ^ 42); }).join(''); }

// Block devtools
document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
document.addEventListener('keydown', function(e){
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key)) || (e.ctrlKey && e.key === 'u')) {
    e.preventDefault(); return false;
  }
});

// Sound alert
function playAlert() {
  if (!soundOn) return;
  try {
    var ctx = new (window.AudioContext || window.webkitAudioContext)();
    [523, 659, 784].forEach(function(freq, i) {
      var o = ctx.createOscillator();
      var g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq;
      o.type = 'sine';
      g.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.3);
      o.start(ctx.currentTime + i * 0.15);
      o.stop(ctx.currentTime + i * 0.15 + 0.3);
    });
  } catch(e) {}
}

function showNewOrderBanner(orderId) {
  var banner = document.getElementById('newOrderBanner');
  document.getElementById('newOrderText').textContent = 'New order ' + orderId + ' just came in!';
  banner.classList.add('show');
  setTimeout(function(){ banner.classList.remove('show'); }, 5000);
}

// LOGIN
function doLogin() {
  if (locked) return;
  var entered = document.getElementById('loginInput').value;
  if (entered === getPassword()) {
    document.getElementById('loginScreen').classList.add('hidden');
    sessionStorage.setItem('ctAdminAuth', '1');
    startApp();
  } else {
    attempts++;
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('loginInput').value = '';
    document.getElementById('loginInput').focus();
    if (attempts >= 5) {
      locked = true;
      document.getElementById('loginInput').disabled = true;
      document.getElementById('loginBtn').disabled = true;
      document.getElementById('loginAttempts').textContent = 'Too many attempts. Refresh to try again.';
      document.getElementById('loginError').textContent = 'üîí Locked out.';
    } else {
      document.getElementById('loginAttempts').textContent = (5 - attempts) + ' attempts remaining.';
    }
  }
}

document.getElementById('loginBtn').addEventListener('click', doLogin);
document.getElementById('loginInput').addEventListener('keydown', function(e){ if (e.key === 'Enter') doLogin(); });

if (sessionStorage.getItem('ctAdminAuth') === '1') {
  document.getElementById('loginScreen').classList.add('hidden');
  startApp();
}

function startApp() {
  fetchState(); loadOrders();
  setInterval(fetchState, 5000);
  setInterval(loadOrders, 8000);

  document.getElementById('bigSwitch').addEventListener('click', handleSwitch);
  document.getElementById('confirmYes').addEventListener('click', confirmShutdown);
  document.getElementById('confirmNo').addEventListener('click', cancelShutdown);
  document.getElementById('clearBtn').addEventListener('click', clearOrders);
  document.getElementById('refreshBtn').addEventListener('click', loadOrders);
  document.getElementById('soundToggle').addEventListener('click', function() {
    soundOn = !soundOn;
    this.textContent = soundOn ? 'ON' : 'OFF';
    this.className = soundOn ? 'sound-toggle' : 'sound-toggle off';
  });
}

// SHUTDOWN
async function fetchState() {
  try {
    var res = await fetch('https://api.jsonbin.io/v3/b/' + SHUTDOWN_BIN + '/latest', { headers: {'X-Master-Key': API_KEY, 'X-Access-Key': API_KEY} });
    var data = await res.json();
    isShutdown = !!(data.record && data.record.shutdown);
    applyState();
  } catch(e) {}
}

async function saveState(val) {
  try {
    await fetch('https://api.jsonbin.io/v3/b/' + SHUTDOWN_BIN, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Access-Key': API_KEY},
      body: JSON.stringify({shutdown: val})
    });
  } catch(e) {}
}

function handleSwitch() {
  if (!isShutdown) {
    document.getElementById('confirmBox').style.display = 'block';
    document.getElementById('switchLabel').textContent = 'CONFIRM BELOW...';
  } else {
    isShutdown = false; saveState(false); applyState();
  }
}

async function confirmShutdown() {
  document.getElementById('confirmBox').style.display = 'none';
  isShutdown = true; await saveState(true); applyState();
}

function cancelShutdown() {
  document.getElementById('confirmBox').style.display = 'none'; applyState();
}

function applyState() {
  var card = document.getElementById('killCard'), btn = document.getElementById('bigSwitch');
  var icon = document.getElementById('switchIcon'), lbl = document.getElementById('switchLabel');
  var desc = document.getElementById('killDesc'), pill = document.getElementById('statusPill');
  var dot  = document.getElementById('statusDot'), stxt = document.getElementById('statusText');
  if (isShutdown) {
    card.classList.add('shutdown'); btn.className = 'big-switch offline';
    icon.textContent = 'üî¥'; lbl.textContent = 'SITE IS SHUT DOWN ‚Äî CLICK TO RESTORE';
    desc.className = 'kill-desc danger'; desc.textContent = 'üî¥ Customers see the CLOSED screen.';
    pill.className = 'status-pill down'; dot.className = 'status-dot down'; stxt.textContent = 'Site Offline';
  } else {
    card.classList.remove('shutdown'); btn.className = 'big-switch online';
    icon.textContent = 'üü¢'; lbl.textContent = 'SITE IS LIVE ‚Äî CLICK TO SHUT DOWN';
    desc.className = 'kill-desc'; desc.textContent = "Shut down when they haven't paid their fee.";
    pill.className = 'status-pill live'; dot.className = 'status-dot live'; stxt.textContent = 'Site Online';
  }
}

// ORDERS
var STATUS_LABEL = {received:'üì• Order Received', preparing:'üë®‚Äçüç≥ Preparing', ontheway:'üõµ On the Way', delivered:'‚úÖ Delivered'};

async function loadOrders() {
  var list = document.getElementById('ordersList');
  try {
    var res  = await fetch('https://api.jsonbin.io/v3/b/' + ORDERS_BIN + '/latest', { headers: {'X-Master-Key': API_KEY, 'X-Access-Key': API_KEY} });
    var data = await res.json();
    var fetched = (data.record && data.record.orders) ? data.record.orders : [];

    // Filter out delivered orders
    allOrders = fetched.filter(function(o){ return o.status !== 'delivered'; });

    // Sound alert for new orders
    if (lastOrderCount > 0 && allOrders.length > lastOrderCount) {
      playAlert();
      showNewOrderBanner(allOrders[0].orderId);
    }
    lastOrderCount = allOrders.length;

    document.getElementById('statOrders').textContent  = allOrders.length;
    document.getElementById('statRevenue').textContent = fetched.reduce(function(s,o){ return s + o.total; }, 0).toLocaleString();

    if (allOrders.length === 0) {
      list.innerHTML = '<div class="no-orders"><div class="no-orders-icon">üçî</div>No active orders.<br>Waiting for customers...</div>';
      return;
    }

    list.innerHTML = '';
    allOrders.forEach(function(o, i) {
      var st   = o.status || 'received';
      var card = document.createElement('div');
      card.className = 'order-card' + (i === 0 && st === 'received' ? ' new-order' : '');

      var headerHTML = '<div class="oc-header"><div><span class="oc-id">' + o.orderId + '</span>'
        + (i === 0 && st === 'received' ? '<span class="new-badge">NEW</span>' : '')
        + '</div><div class="oc-time">' + o.time + '</div></div>';

      var bodyHTML = '<div class="oc-status-badge badge-' + st + '">' + (STATUS_LABEL[st] || STATUS_LABEL.received) + '</div>'
        + '<div class="oc-customer">üë§ ' + o.name + ' &nbsp;¬∑&nbsp; üìû ' + o.phone + '</div>'
        + '<div class="oc-address">üìç ' + o.address + '</div>'
        + '<div class="oc-items">' + o.items.map(function(item){ return item.emoji + ' ' + item.name + ' &times;' + item.qty; }).join('<br>') + '</div>'
        + (o.note ? '<div class="oc-note">üìù ' + o.note + '</div>' : '')
        + '<div class="oc-total">Total: &#8369;' + o.total.toLocaleString() + '.00</div>';

      card.innerHTML = headerHTML + bodyHTML;

      // Status buttons
      var btnsDiv = document.createElement('div');
      btnsDiv.className = 'status-btns';
      [{key:'received',label:'üì• Received'},{key:'preparing',label:'üë®‚Äçüç≥ Preparing'},{key:'ontheway',label:'üõµ On the Way'},{key:'delivered',label:'‚úÖ Delivered'}].forEach(function(s) {
        var sbtn = document.createElement('button');
        sbtn.className = 'status-btn' + (st === s.key ? ' s-' + s.key : '');
        sbtn.textContent = s.label;
        sbtn.addEventListener('click', (function(idx, skey){ return function(){ updateStatus(idx, skey); }; })(i, s.key));
        btnsDiv.appendChild(sbtn);
      });
      card.appendChild(btnsDiv);

      // Print button
      var actionsDiv = document.createElement('div');
      actionsDiv.className = 'card-actions';
      var printBtn = document.createElement('button');
      printBtn.className = 'print-btn';
      printBtn.textContent = 'üñ®Ô∏è Print';
      printBtn.addEventListener('click', (function(order){ return function(){ printOrder(order); }; })(o));
      actionsDiv.appendChild(printBtn);
      card.appendChild(actionsDiv);

      list.appendChild(card);
    });

  } catch(e) {
    list.innerHTML = '<div class="no-orders">‚ö†Ô∏è Could not load orders.</div>';
  }
}

async function updateStatus(index, newStatus) {
  // Get fresh orders from bin first (including delivered ones)
  try {
    var res  = await fetch('https://api.jsonbin.io/v3/b/' + ORDERS_BIN + '/latest', { headers: {'X-Master-Key': API_KEY, 'X-Access-Key': API_KEY} });
    var data = await res.json();
    var all  = (data.record && data.record.orders) ? data.record.orders : [];
    // Find this order by orderId and update it
    var targetId = allOrders[index].orderId;
    var found = all.find(function(o){ return o.orderId === targetId; });
    if (found) found.status = newStatus;
    await fetch('https://api.jsonbin.io/v3/b/' + ORDERS_BIN, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Access-Key': API_KEY},
      body: JSON.stringify({orders: all})
    });
    loadOrders();
  } catch(e) {}
}

async function clearOrders() {
  if (!confirm('Clear all orders? This cannot be undone.')) return;
  try {
    await fetch('https://api.jsonbin.io/v3/b/' + ORDERS_BIN, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Access-Key': API_KEY},
      body: JSON.stringify({orders: []})
    });
    lastOrderCount = 0;
    loadOrders();
  } catch(e) {}
}

function printOrder(o) {
  var w = window.open('', '_blank');
  w.document.write('<html><head><title>Order ' + o.orderId + '</title><style>body{font-family:Arial,sans-serif;padding:24px;max-width:400px;margin:0 auto;}h2{color:#E8272B;}hr{border:1px solid #eee;margin:12px 0;}.total{font-size:1.4rem;font-weight:700;color:#E8272B;}</style></head><body>');
  w.document.write('<h2>CESS TUNA</h2><hr>');
  w.document.write('<p><strong>Order ID:</strong> ' + o.orderId + '</p>');
  w.document.write('<p><strong>Time:</strong> ' + o.time + '</p>');
  w.document.write('<p><strong>Customer:</strong> ' + o.name + '</p>');
  w.document.write('<p><strong>Phone:</strong> ' + o.phone + '</p>');
  w.document.write('<p><strong>Address:</strong> ' + o.address + '</p>');
  w.document.write('<hr><h3>Items:</h3>');
  o.items.forEach(function(item){ w.document.write('<p>' + item.emoji + ' ' + item.name + ' x' + item.qty + ' = &#8369;' + (item.price * item.qty) + '</p>'); });
  w.document.write('<hr><p class="total">TOTAL: &#8369;' + o.total.toLocaleString() + '.00</p>');
  if (o.note) w.document.write('<p><em>Note: ' + o.note + '</em></p>');
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}
</script>
</body>
</html>
